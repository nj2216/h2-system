{% extends "base.html" %}

{% block title %}Sick Leave Calendar - H2 System{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h2><i class="bi bi-calendar2-event"></i> Sick Leave Calendar</h2>
    </div>
    <div class="col-md-4 text-end">
        <a href="{{ url_for('sickleave.requests_list') }}" class="btn btn-outline-secondary">
            <i class="bi bi-list-check"></i> List View
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-9">
        <!-- Calendar Card -->
        <div class="card shadow">
            <div class="card-header border-bottom">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="mb-0" id="monthYear" style="cursor: pointer;" title="Click to select month and year">
                            <i class="bi bi-calendar2"></i> <span id="monthYearText"></span>
                        </h5>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-sm btn-outline-secondary" onclick="previousMonth()">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="today()">Today</button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="nextMonth()">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered mb-0" style="table-layout: fixed;">
                        <thead style="background-color: var(--light-muted); color: var(--light-text);">
                            <tr>
                                <th class="text-center">Sun</th>
                                <th class="text-center">Mon</th>
                                <th class="text-center">Tue</th>
                                <th class="text-center">Wed</th>
                                <th class="text-center">Thu</th>
                                <th class="text-center">Fri</th>
                                <th class="text-center">Sat</th>
                            </tr>
                        </thead>
                        <tbody id="calendarBody">
                            <!-- Calendar days will be generated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Legend -->
        <div class="row mt-3">
            <div class="col-md-12">
                <small class="text-muted">
                    <span class="badge bg-success me-2">Approved</span>
                    <span class="badge bg-warning me-2">Pending</span>
                    <span class="badge bg-danger">Rejected</span>
                </small>
            </div>
        </div>
    </div>

    <!-- Sidebar - Selected Day Details -->
    <div class="col-md-3">
        <div class="card shadow">
            <div class="card-header border-bottom">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle"></i> Details
                </h5>
            </div>
            <div class="card-body" id="dayDetails">
                <p class="text-muted text-center">Select a date to view details</p>
            </div>
        </div>
    </div>
</div>

<!-- Month/Year Selector Modal -->
<div class="modal fade" id="monthYearModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-bottom">
                <h5 class="modal-title">Select Month and Year</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col">
                        <label class="form-label">Month</label>
                        <select class="form-select" id="monthSelector">
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    <div class="col">
                        <label class="form-label">Year</label>
                        <input type="number" class="form-control" id="yearSelector" min="2020" max="2030">
                    </div>
                </div>
            </div>
            <div class="modal-footer border-top">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="setMonthYear()">Apply</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentYear = {{ year if year is not none else 'null' }};
let currentMonth = {{ month if month is not none else 'null' }};

// Fallback to current date if server did not provide year/month
if (!currentYear || !currentMonth) {
    const now = new Date();
    currentYear = now.getFullYear();
    currentMonth = now.getMonth() + 1;
}

let calendarEvents = [];
let selectedDate = null;

// Load events on page load
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('monthYear').addEventListener('click', function() {
        document.getElementById('monthSelector').value = currentMonth;
        document.getElementById('yearSelector').value = currentYear;
        const modal = new bootstrap.Modal(document.getElementById('monthYearModal'));
        modal.show();
    });
    
    loadEvents();
    renderCalendar();
});

function loadEvents() {
    fetch(`{{ url_for('sickleave.calendar_data') }}?year=${currentYear}&month=${currentMonth}`)
        .then(response => response.json())
        .then(data => {
            calendarEvents = data;
            renderCalendar();
        });
}

function renderCalendar() {
    // Update month/year display
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'];
    document.getElementById('monthYearText').textContent = `${monthNames[currentMonth - 1]} ${currentYear}`;

    // Get first day of month and number of days
    const firstDay = new Date(currentYear, currentMonth - 1, 1).getDay();
    const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
    const daysInPrevMonth = new Date(currentYear, currentMonth - 1, 0).getDate();

    const calendarBody = document.getElementById('calendarBody');
    calendarBody.innerHTML = '';

    let date = 1;
    let nextDate = 1;

    for (let i = 0; i < 6; i++) {
        const row = document.createElement('tr');
        row.style.height = '100px';

        for (let j = 0; j < 7; j++) {
            const cell = document.createElement('td');
            cell.style.verticalAlign = 'top';
            cell.style.padding = '8px';

            if (i === 0 && j < firstDay) {
                // Previous month's days
                cell.classList.add('text-muted');
                cell.style.backgroundColor = 'var(--light-muted)';
                cell.innerHTML = `<small>${daysInPrevMonth - firstDay + j + 1}</small>`;
            } else if (date > daysInMonth) {
                // Next month's days
                cell.classList.add('text-muted');
                cell.style.backgroundColor = 'var(--light-muted)';
                cell.innerHTML = `<small>${nextDate++}</small>`;
            } else {
                // Current month's days
                const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                const dayEvents = calendarEvents.filter(e => e.date === dateStr);

                const today = new Date();
                const isToday = date === today.getDate() && currentMonth === today.getMonth() + 1 && currentYear === today.getFullYear();

                if (isToday) {
                    cell.classList.add('border-2', 'border-primary');
                    cell.style.backgroundColor = 'rgba(13, 110, 253, 0.05)';
                }

                let content = `<div class="fw-bold mb-2" style="color: var(--light-text);">${date}</div>`;

                if (dayEvents.length > 0) {
                    content += `<div class="event-list">`;
                    dayEvents.forEach(event => {
                        const icon = event.type === 'Sick Food' ? 'üç≤' : 'üè•';
                        const viewUrl = `/sickleave/${event.request_id}`;
                        content += `<a href="${viewUrl}" 
                                      class="badge bg-${event.color} text-decoration-none d-block mb-1" 
                                      style="font-size: 0.7rem; cursor: pointer;" 
                                      title="${event.student} - ${event.type}">
                                      ${icon} ${event.type.split(' ')[0]}
                                    </a>`;
                    });
                    content += `</div>`;
                }

                cell.innerHTML = content;
                cell.style.cursor = 'pointer';
                
                // Highlight selected date
                if (selectedDate === dateStr) {
                    cell.style.backgroundColor = 'rgba(13, 110, 253, 0.25)';
                    cell.style.border = '2px solid var(--bs-primary)';
                }
                
                cell.onclick = () => {
                    selectedDate = dateStr;
                    renderCalendar();
                    showDayDetails(dateStr, dayEvents);
                };
                
                date++;  // IMPORTANT: Increment date for current month
            }

            row.appendChild(cell);
        }

        calendarBody.appendChild(row);

        if (date > daysInMonth) {
            break;
        }
    }
}

function showDayDetails(dateStr, dayEvents) {
    const dayDetails = document.getElementById('dayDetails');

    if (dayEvents.length === 0) {
        dayDetails.innerHTML = `
            <p class="text-muted text-center">
                <small>No requests on this date</small>
            </p>
        `;
        return;
    }

    let html = `<small class="text-muted">${dateStr}</small>`;
    html += '<div class="mt-3">';

    dayEvents.forEach(event => {
        const icon = event.type === 'Sick Food' ? 'üç≤' : 'üè•';
        const statusColor = event.status === 'Approved' ? 'success' : event.status === 'Pending' ? 'warning' : 'danger';
        const viewUrl = `/sickleave/${event.request_id}`;

        html += `
            <div class="mb-3 p-2 border rounded">
                <div class="d-flex align-items-center mb-2">
                    <span style="font-size: 1.5rem; margin-right: 8px;">${icon}</span>
                    <div>
                        <strong class="d-block">${event.student}</strong>
                        <small class="text-muted">${event.type}</small>
                    </div>
                </div>
                <span class="badge bg-${statusColor} mb-2">${event.status}</span>
                <br>
                <a href="${viewUrl}" class="btn btn-sm btn-outline-primary mt-2">
                    View Details
                </a>
            </div>
        `;
    });

    html += '</div>';
    dayDetails.innerHTML = html;
}

function setMonthYear() {
    const newMonth = parseInt(document.getElementById('monthSelector').value);
    const newYear = parseInt(document.getElementById('yearSelector').value);
    
    if (newMonth >= 1 && newMonth <= 12 && newYear > 0) {
        currentMonth = newMonth;
        currentYear = newYear;
        loadEvents();
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('monthYearModal'));
        modal.hide();
    }
}

function previousMonth() {
    currentMonth--;
    if (currentMonth < 1) {
        currentMonth = 12;
        currentYear--;
    }
    loadEvents();
}

function nextMonth() {
    currentMonth++;
    if (currentMonth > 12) {
        currentMonth = 1;
        currentYear++;
    }
    loadEvents();
}

function today() {
    const now = new Date();
    currentYear = now.getFullYear();
    currentMonth = now.getMonth() + 1;
    loadEvents();
}
</script>

<style>
#calendarBody td {
    border: 1px solid var(--light-border);
    position: relative;
    overflow-y: auto;
}

.event-list {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.event-list a {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
</style>
{% endblock %}

{% extends "base.html" %}

{% block title %}Medicine Details{% endblock %}

{% block content %}
<style>
    .medicine-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 0.5rem;
        margin-bottom: 2rem;
    }

    .batch-table-container {
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .batch-row {
        border-left: 4px solid var(--bs-border-color);
        transition: all 0.3s ease;
    }

    .batch-row:hover {
        background-color: #f8f9fa;
    }

    .batch-row.fefo-priority {
        border-left-color: var(--bs-success);
        background-color: #f0fdf4;
    }

    .batch-row.expiring-soon {
        border-left-color: var(--bs-warning);
        background-color: #fffbeb;
    }

    .batch-row.expired {
        border-left-color: var(--bs-danger);
        background-color: #fef2f2;
        opacity: 0.7;
    }

    .fefo-badge {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 2rem;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .expiry-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 2rem;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .expiry-badge.expiring-soon {
        background-color: #fef3c7;
        color: #92400e;
    }

    .expiry-badge.expired {
        background-color: #fee2e2;
        color: #991b1b;
    }

    .shelf-badge {
        background-color: #dbeafe;
        color: #1e40af;
        padding: 0.25rem 0.75rem;
        border-radius: 2rem;
        font-size: 0.85rem;
    }

    .stock-summary {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-left: 4px solid var(--bs-info);
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
    }

    .summary-stat {
        text-align: center;
        padding: 1rem;
    }

    .summary-stat .stat-value {
        font-size: 1.8rem;
        font-weight: bold;
        color: var(--bs-info);
    }

    .summary-stat .stat-label {
        font-size: 0.9rem;
        color: #6b7280;
        margin-top: 0.25rem;
    }

    .add-batch-btn {
        margin-bottom: 1.5rem;
    }
</style>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <!-- Medicine Header -->
            <div class="medicine-header">
                <h2 class="mb-2"><i class="bi bi-capsule"></i> {{ medicine.name }}</h2>
                <p class="mb-0" style="font-size: 1.1rem; opacity: 0.95;">
                    <strong>{{ medicine.dosage }}</strong> • 
                    Generic: {{ medicine.generic_name or 'N/A' }} • 
                    Unit: {{ medicine.unit }}
                </p>
            </div>

            <!-- Medicine Information Card -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle"></i> Medicine Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Supplier:</strong> {{ medicine.supplier or 'N/A' }}
                        </div>
                        <div class="col-md-6">
                            <strong>Cost Per Unit:</strong> ₹{{ "%.2f"|format(medicine.cost_per_unit or 0) }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Min Stock Level:</strong> {{ medicine.min_stock_level }} units
                        </div>
                        <div class="col-md-6">
                            <strong>Total Batches:</strong> {{ medicine.batches|length }} batch(es)
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stock Summary -->
            <div class="stock-summary">
                <div class="row">
                    <div class="col-md-4 summary-stat">
                        <div class="stat-value">{{ medicine.total_batch_quantity }}</div>
                        <div class="stat-label">Total Available</div>
                    </div>
                    <div class="col-md-4 summary-stat">
                        <div class="stat-value">{{ medicine.batches|length }}</div>
                        <div class="stat-label">Active Batches</div>
                    </div>
                    <div class="col-md-4 summary-stat">
                        <div class="stat-value">
                            {% if medicine.batches|length > 0 %}
                                {% set found_days = false %}
                                {% for batch in medicine.batches|sort(attribute='expiry_date') %}
                                    {% if not batch.is_expired and not found_days %}
                                        {{ batch.days_to_expiry }}
                                        {% set found_days = true %}
                                    {% endif %}
                                {% endfor %}
                                {% if not found_days %}
                                    -
                                {% endif %}
                            {% else %}
                                -
                            {% endif %}
                        </div>
                        <div class="stat-label">Days to Expiry (FEFO)</div>
                    </div>
                </div>
            </div>

            <!-- Batches Section -->
            <div class="card mb-4">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-box-seam"></i> Stock Batches (FEFO Order)
                    </h5>
                    <a href="{{ url_for('health.add_medicine_batch', medicine_id=medicine.id) }}" class="btn btn-sm btn-primary">
                        <i class="bi bi-plus-circle"></i> Add New Batch
                    </a>
                </div>
                <div class="card-body">
                    <!-- DEBUG: medicine.batches|length = {{ medicine.batches|length }}, total_batch_quantity = {{ medicine.total_batch_quantity }} -->
                    {% if medicine.batches and medicine.batches|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Priority</th>
                                    <th>Batch Number</th>
                                    <th>Shelf Location</th>
                                    <th>Quantity Available</th>
                                    <th>Expiry Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set fefo_index = 0 %}
                                {% for batch in medicine.batches|sort(attribute='expiry_date') %}
                                    {% if not batch.is_expired %}
                                        {% set fefo_index = fefo_index + 1 %}
                                    {% endif %}
                                {% endfor %}
                                
                                <!-- Display all batches (active and expired) -->
                                {% set fefo_index = 0 %}
                                {% for batch in medicine.batches|sort(attribute='expiry_date') %}
                                    {% if not batch.is_expired %}
                                        {% set fefo_index = fefo_index + 1 %}
                                    {% endif %}
                                    
                                    <tr class="batch-row {% if batch.is_expired %}expired{% elif fefo_index == 1 and not batch.is_expired %}fefo-priority{% elif not batch.is_expired and batch.days_to_expiry < 30 %}expiring-soon{% endif %}">
                                        <td>
                                            {% if batch.is_expired %}
                                                <span class="badge bg-danger">EXPIRED</span>
                                            {% elif fefo_index == 1 %}
                                                <span class="fefo-badge"><i class="bi bi-star-fill"></i> FEFO #1</span>
                                            {% else %}
                                                <span class="badge bg-secondary">#{{ fefo_index }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <strong>{{ batch.batch_number }}</strong>
                                        </td>
                                        <td>
                                            <span class="shelf-badge">
                                                <i class="bi bi-geo-alt-fill"></i> {{ batch.shelf_location }}
                                            </span>
                                        </td>
                                        <td>
                                            <strong class="text-info">{{ batch.available_quantity }} / {{ batch.quantity }}</strong>
                                            {% if batch.available_quantity < 5 and batch.available_quantity > 0 %}
                                                <br><small class="text-warning"><i class="bi bi-exclamation-triangle"></i> Low</small>
                                            {% elif batch.available_quantity == 0 %}
                                                <br><small class="text-danger"><i class="bi bi-x-circle"></i> Empty</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column gap-1">
                                                <strong>{{ batch.expiry_date }}</strong>
                                                {% if not batch.is_expired and batch.days_to_expiry is not none %}
                                                    {% if batch.days_to_expiry < 30 and batch.days_to_expiry >= 0 %}
                                                        <span class="expiry-badge expiring-soon">
                                                            <i class="bi bi-clock"></i> {{ batch.days_to_expiry }} days
                                                        </span>
                                                    {% endif %}
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            {% if batch.is_expired %}
                                                <span class="badge bg-danger"><i class="bi bi-exclamation-circle"></i> EXPIRED</span>
                                            {% elif batch.available_quantity == 0 %}
                                                <span class="badge bg-warning text-dark">OUT OF STOCK</span>
                                            {% elif batch.days_to_expiry is not none and batch.days_to_expiry < 7 %}
                                                <span class="badge bg-danger">CRITICAL</span>
                                            {% elif batch.days_to_expiry is not none and batch.days_to_expiry < 30 %}
                                                <span class="badge bg-warning text-dark">WARNING</span>
                                            {% else %}
                                                <span class="badge bg-success">OK</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <a href="{{ url_for('health.batch_dispensing_history', batch_id=batch.id) }}" 
                                               class="btn btn-sm btn-outline-secondary" title="View dispensing history">
                                                <i class="bi bi-clock-history"></i> History
                                            </a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle"></i> No batches found. 
                        <a href="{{ url_for('health.add_medicine_batch', medicine_id=medicine.id) }}" class="alert-link">Add a new batch</a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Dispense History -->
            {% if medicine.batches and medicine.batches[0].dispensings %}
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-receipt"></i> Recent Dispensing History
                    </h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Date</th>
                                <th>Batch Number</th>
                                <th>Shelf Location</th>
                                <th>Qty Dispensed</th>
                                <th>Staff Member</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set dispensing_count = 0 %}
                            {% for batch in medicine.batches %}
                                {% for dispensing in batch.dispensings[:5] %}
                                    {% if dispensing_count < 10 %}
                                        <tr>
                                            <td>{{ dispensing.dispensed_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                            <td><strong>{{ batch.batch_number }}</strong></td>
                                            <td>
                                                <span class="shelf-badge">
                                                    <i class="bi bi-geo-alt-fill"></i> {{ batch.shelf_location }}
                                                </span>
                                            </td>
                                            <td>{{ dispensing.quantity_dispensed }}</td>
                                            <td>{{ dispensing.dispensed_by.username if dispensing.dispensed_by else 'System' }}</td>
                                        </tr>
                                        {% set dispensing_count = dispensing_count + 1 %}
                                    {% endif %}
                                {% endfor %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- Navigation -->
            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4 mb-4">
                <a href="{{ url_for('stock.inventory') }}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Inventory
                </a>
                <a href="{{ url_for('stock.edit_medicine', medicine_id=medicine.id) }}" class="btn btn-primary">
                    <i class="bi bi-pencil"></i> Edit Details
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    // Form validation
    (function () {
        'use strict';
        window.addEventListener('load', function () {
            var forms = document.querySelectorAll('.needs-validation');
            Array.prototype.slice.call(forms).forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        }, false);
    }());
</script>
{% endblock %}

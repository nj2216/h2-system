{% extends "base.html" %}

{% block title %}Prescribe During Visit - H2 System{% endblock %}

{% block content %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<style>
    .select2-container--default .select2-selection--single {
        border: 1px solid var(--bs-border-color);
        border-radius: 0.375rem;
        background-color: var(--bs-body-bg);
        color: var(--bs-body-color);
    }

    .select2-dropdown {
        background-color: var(--bs-body-bg);
        border-color: var(--bs-border-color);
    }

    .select2-results__option {
        color: var(--bs-body-color);
    }

    .select2-results__option--highlighted,
    .select2-results__option[aria-selected=true] {
        background-color: var(--bs-primary);
        color: white;
    }

    .medicine-item {
        background-color: var(--light-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        position: relative;
    }

    .btn-remove-medicine {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
    }

    @keyframes slideIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideOut {
        from { opacity: 1; transform: translateY(0); }
        to { opacity: 0; transform: translateY(-10px); }
    }

    .medicine-item {
        animation: slideIn 0.3s ease-in;
    }

    .stock-warning {
        background-color: var(--bs-warning);
        opacity: 0.8;
        color: #000;
        padding: 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.85rem;
        margin-top: 0.25rem;
    }
</style>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="bi bi-prescription2"></i> Prescribe During Visit</h2>
                    <p class="text-muted">Add medicines to prescribe during this doctor visit</p>
                </div>
                <div>
                    <a href="{{ url_for('health.view_visit', visit_id=visit.id) }}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Visit
                    </a>
                </div>
            </div>

            <!-- Visit Info Card -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Visit Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <small class="text-muted">Student</small>
                            <p class="mb-0"><strong>{{ visit.student.user.first_name }} {{ visit.student.user.last_name }}</strong></p>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">Roll Number</small>
                            <p class="mb-0"><strong>{{ visit.student.roll_number }}</strong></p>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">Visit Date</small>
                            <p class="mb-0"><strong>{{ visit.visit_date.strftime('%Y-%m-%d') }}</strong></p>
                        </div>
                    </div>
                    {% if visit.diagnosis %}
                    <div class="row mt-3">
                        <div class="col-12">
                            <small class="text-muted">Diagnosis</small>
                            <p class="mb-0">{{ visit.diagnosis }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Prescription Form -->
            <form method="POST" class="needs-validation" novalidate id="prescriptionForm">
                <!-- Medicines Section -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-capsule"></i> Medicines to Prescribe</h5>
                        <button type="button" class="btn btn-sm btn-light" onclick="addMedicineRow()">
                            <i class="bi bi-plus-circle"></i> Add Medicine
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="medicinesList">
                            <!-- Medicine rows will be added here -->
                        </div>
                        <button type="button" class="btn btn-outline-info w-100 mt-3" onclick="addMedicineRow()">
                            <i class="bi bi-plus"></i> Add Another Medicine
                        </button>
                    </div>
                </div>

                <!-- Notes -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-chat-left-text"></i> Prescription Notes</h5>
                    </div>
                    <div class="card-body">
                        <textarea class="form-control" name="notes" rows="3" placeholder="Any additional notes for this prescription..."></textarea>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="d-flex gap-2 mb-4">
                    <button type="submit" class="btn btn-primary btn-lg flex-grow-1">
                        <i class="bi bi-check-circle"></i> Create Prescription
                    </button>
                    <a href="{{ url_for('health.view_visit', visit_id=visit.id) }}" class="btn btn-secondary btn-lg">
                        <i class="bi bi-x-circle"></i> Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Medicine Row Template (Hidden) -->
<template id="medicineRowTemplate">
    <div class="medicine-item">
        <button type="button" class="btn btn-sm btn-danger btn-remove-medicine" onclick="removeMedicineRow(this)">
            <i class="bi bi-x-lg"></i>
        </button>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label fw-600">Medicine <span class="text-danger">*</span></label>
                <select class="form-select select2-med" name="medicine_id" required onchange="updateMedicineDetails(this)">
                    <option value="">Select a medicine...</option>
                    {% for medicine in medicines %}
                    <option value="{{ medicine.id }}" data-stock="{{ medicine.quantity }}" data-dosage="{{ medicine.dosage }}" data-unit="{{ medicine.unit }}" data-generic="{{ medicine.generic_name or '' }}">
                        {{ medicine.name }} ({{ medicine.dosage }}) â€“ Stock: {{ medicine.quantity }} {{ medicine.unit }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3 mb-3">
                <label class="form-label">Dosage</label>
                <input type="text" class="form-control dosage-field" name="dosage[]" readonly placeholder="Auto-filled">
            </div>

            <div class="col-md-3 mb-3">
                <label class="form-label">Stock Available</label>
                <div class="input-group">
                    <input type="text" class="form-control stock-field" readonly placeholder="0">
                    <span class="input-group-text unit-field">units</span>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-3 mb-3">
                <label class="form-label fw-600">Frequency <span class="text-danger">*</span></label>
                <select class="form-select frequency-field" name="frequency[]" required onchange="updateQuantity(this)">
                    <option value="">Select frequency...</option>
                    <option value="1">1 time daily</option>
                    <option value="2">2 times daily</option>
                    <option value="3">3 times daily</option>
                    <option value="4">4 times daily</option>
                    <option value="1/2">Every 12 hours (2 times daily)</option>
                    <option value="1/3">Every 8 hours (3 times daily)</option>
                    <option value="1/6">Every 6 hours (4 times daily)</option>
                    <option value="0.5">Once in 2 days</option>
                </select>
            </div>

            <div class="col-md-3 mb-3">
                <label class="form-label fw-600">Duration (Days) <span class="text-danger">*</span></label>
                <input type="number" class="form-control duration-field" name="duration_days[]" min="1" value="7" required onchange="updateQuantity(this)">
            </div>

            <div class="col-md-3 mb-3">
                <label class="form-label fw-600">Quantity <span class="text-danger">*</span></label>
                <input type="number" class="form-control quantity-field" name="quantity_prescribed[]" min="1" value="1" required readonly style="background-color: var(--bs-light);">
                <small class="text-muted">Auto-calculated</small>
            </div>

            <div class="col-md-3 mb-3">
                <label class="form-label">Status</label>
                <input type="text" class="form-control status-field" value="PENDING" readonly style="background-color: var(--bs-warning); opacity: 0.7;">
            </div>
        </div>

        <div class="stock-status-warning" style="display: none;">
            <div class="stock-warning">
                <i class="bi bi-exclamation-triangle"></i> 
                <strong>Out of Stock:</strong> This medicine will be marked for purchasing. A placeholder will be created.
            </div>
        </div>

        <div class="row">
            <div class="col-12 mb-3">
                <label class="form-label">Instructions</label>
                <textarea class="form-control" name="instructions[]" rows="2" placeholder="e.g., Take with food, avoid dairy products"></textarea>
            </div>
        </div>
    </div>
</template>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    let medicineRowCount = 0;

    function addMedicineRow() {
        const template = document.getElementById('medicineRowTemplate');
        const clone = template.content.cloneNode(true);
        const medicinesList = document.getElementById('medicinesList');
        
        medicinesList.appendChild(clone);
        medicineRowCount++;
        
        initializeSelect2();
    }

    function removeMedicineRow(btn) {
        const row = btn.closest('.medicine-item');
        if (document.querySelectorAll('.medicine-item').length > 1) {
            row.style.animation = 'slideOut 0.3s ease-out';
            setTimeout(() => row.remove(), 300);
        } else {
            alert('You must have at least one medicine in the prescription.');
        }
    }

    function updateMedicineDetails(select) {
        const option = select.options[select.selectedIndex];
        const row = select.closest('.medicine-item');
        
        if (option.value) {
            const dosage = option.getAttribute('data-dosage') || '';
            const stock = option.getAttribute('data-stock') || '0';
            const unit = option.getAttribute('data-unit') || 'units';
            
            row.querySelector('.dosage-field').value = dosage;
            row.querySelector('.stock-field').value = stock;
            row.querySelector('.unit-field').textContent = unit;
            
            // Show warning if out of stock
            const quantityField = row.querySelector('.quantity-field');
            const warningDiv = row.querySelector('.stock-status-warning');
            
            if (parseInt(stock) === 0) {
                row.querySelector('.status-field').value = 'OUT_OF_STOCK';
                warningDiv.style.display = 'block';
            } else {
                row.querySelector('.status-field').value = 'PENDING';
                warningDiv.style.display = 'none';
            }
        } else {
            row.querySelector('.dosage-field').value = '';
            row.querySelector('.stock-field').value = '';
            row.querySelector('.unit-field').textContent = 'units';
            row.querySelector('.status-field').value = 'PENDING';
            row.querySelector('.stock-status-warning').style.display = 'none';
        }
    }

    function updateQuantity(field) {
        const row = field.closest('.medicine-item');
        const frequencyField = row.querySelector('.frequency-field');
        const durationField = row.querySelector('.duration-field');
        const quantityField = row.querySelector('.quantity-field');
        
        const frequency = frequencyField.value;
        const duration = parseInt(durationField.value) || 0;
        
        if (frequency && duration > 0) {
            let frequencyMultiplier = 1;
            
            // Parse frequency value
            if (frequency.includes('/')) {
                // For fractional frequencies like "1/2" (every 12 hours)
                const parts = frequency.split('/');
                frequencyMultiplier = parseInt(parts[0]) / parseInt(parts[1]);
            } else {
                frequencyMultiplier = parseFloat(frequency);
            }
            
            // Calculate quantity: frequency * duration
            const calculatedQuantity = Math.ceil(frequencyMultiplier * duration);
            quantityField.value = calculatedQuantity;
        }
    }

    function initializeSelect2() {
        $('.select2-med').select2({
            placeholder: 'Select a medicine...',
            allowClear: true,
            width: '100%'
        });
    }

    // Form validation
    document.getElementById('prescriptionForm').addEventListener('submit', function(e) {
        const medicines = document.querySelectorAll('.medicine-item');
        
        if (medicines.length === 0) {
            e.preventDefault();
            alert('Please add at least one medicine.');
            return false;
        }

        let validMedicines = true;
        medicines.forEach(row => {
            const medicineSelect = row.querySelector('select[name="medicine_id"]');
            const frequency = row.querySelector('select[name="frequency[]"]');
            const quantity = row.querySelector('input[name="quantity_prescribed[]"]');

            if (!medicineSelect.value) {
                validMedicines = false;
                alert('Please select a medicine for all rows.');
                return false;
            }

            if (!frequency.value) {
                validMedicines = false;
                alert('Please select frequency for all medicines.');
                return false;
            }

            if (!quantity.value || quantity.value < 1) {
                validMedicines = false;
                alert('Quantity must be at least 1.');
                return false;
            }
        });

        if (!validMedicines) {
            e.preventDefault();
        }
    });

    // Add one medicine row on page load
    document.addEventListener('DOMContentLoaded', function() {
        addMedicineRow();
        initializeSelect2();
    });
</script>
{% endblock %}

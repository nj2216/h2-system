{% extends "base.html" %}

{% block title %}Prescribe During Visit - H2 System{% endblock %}

{% block content %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<style>
    .select2-container--default .select2-selection--single {
        border: 1px solid var(--bs-border-color);
        border-radius: 0.375rem;
        background-color: var(--bs-body-bg);
        color: var(--bs-body-color);
    }

    .select2-dropdown {
        background-color: var(--bs-body-bg);
        border-color: var(--bs-border-color);
    }

    .select2-results__option {
        color: var(--bs-body-color);
    }

    .select2-results__option--highlighted,
    .select2-results__option[aria-selected=true] {
        background-color: var(--bs-primary);
        color: white;
    }

    .medicine-item {
        background-color: var(--light-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        position: relative;
    }

    .btn-remove-medicine {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
    }

    @keyframes slideIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideOut {
        from { opacity: 1; transform: translateY(0); }
        to { opacity: 0; transform: translateY(-10px); }
    }

    .medicine-item {
        animation: slideIn 0.3s ease-in;
    }

    .stock-warning {
        background-color: var(--bs-warning);
        opacity: 0.8;
        color: #000;
        padding: 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.85rem;
        margin-top: 0.25rem;
    }
</style>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="bi bi-prescription2"></i> Prescribe During Visit</h2>
                    <p class="text-muted">Add medicines to prescribe during this doctor visit</p>
                </div>
                <div>
                    <a href="{{ url_for('health.view_visit', visit_id=visit.id) }}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Visit
                    </a>
                </div>
            </div>

            <!-- Visit Info Card -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Visit Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <small class="text-muted">Student</small>
                            <p class="mb-0"><strong>{{ visit.student.user.first_name }} {{ visit.student.user.last_name }}</strong></p>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">Roll Number</small>
                            <p class="mb-0"><strong>{{ visit.student.roll_number }}</strong></p>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">Visit Date</small>
                            <p class="mb-0"><strong>{{ visit.visit_date.strftime('%Y-%m-%d') }}</strong></p>
                        </div>
                    </div>
                    {% if visit.diagnosis %}
                    <div class="row mt-3">
                        <div class="col-12">
                            <small class="text-muted">Diagnosis</small>
                            <p class="mb-0">{{ visit.diagnosis }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Prescription Form -->
            <form method="POST" class="needs-validation" novalidate id="prescriptionForm">
                <!-- Medicines Section -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-capsule"></i> Medicines to Prescribe</h5>
                        <button type="button" class="btn btn-sm btn-light" onclick="addMedicineRow()">
                            <i class="bi bi-plus-circle"></i> Add Medicine
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="medicinesList">
                            <!-- Medicine rows will be added here -->
                        </div>
                        <button type="button" class="btn btn-outline-info w-100 mt-3" onclick="addMedicineRow()">
                            <i class="bi bi-plus"></i> Add Another Medicine
                        </button>
                    </div>
                </div>

                <!-- Notes -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-chat-left-text"></i> Prescription Notes</h5>
                    </div>
                    <div class="card-body">
                        <textarea class="form-control" name="notes" rows="3" placeholder="Any additional notes for this prescription..."></textarea>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="d-flex gap-2 mb-4">
                    <button type="submit" class="btn btn-primary btn-lg flex-grow-1">
                        <i class="bi bi-check-circle"></i> Create Prescription
                    </button>
                    <a href="{{ url_for('health.view_visit', visit_id=visit.id) }}" class="btn btn-secondary btn-lg">
                        <i class="bi bi-x-circle"></i> Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Medicine Row Template (Hidden) -->
<template id="medicineRowTemplate">
    <div class="medicine-item">
        <button type="button" class="btn btn-sm btn-danger btn-remove-medicine" onclick="removeMedicineRow(this)">
            <i class="bi bi-x-lg"></i>
        </button>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label fw-600">Medicine <span class="text-danger">*</span></label>
                <select class="form-select select2-med" name="medicine_id" required onchange="updateMedicineDetails(this)">
                    <option value="">Select a medicine...</option>
                    <option value="NEW" data-stock="0" style="color: #28a745; font-weight: bold;">
                        ➕ Add New Medicine Not in List
                    </option>
                    {% for medicine in medicines %}
                    <option value="{{ medicine.id }}" data-stock="{{ medicine.display_quantity }}" data-dosage="{{ medicine.dosage }}" data-unit="{{ medicine.unit }}" data-generic="{{ medicine.generic_name or '' }}">
                        {% if medicine.display_quantity == 0 %}
                        ⚠️ {{ medicine.name }} ({{ medicine.dosage }}) – OUT OF STOCK
                        {% else %}
                        {{ medicine.name }} ({{ medicine.dosage }}) – Stock: {{ medicine.display_quantity }} {{ medicine.unit }}
                        {% endif %}
                    </option>
                    {% endfor %}
                </select>
                <small class="form-text text-muted d-block mt-2">⚠️ Out-of-stock medicines will be created as dummy medicines for later replacement.</small>
            </div>

            <div class="col-md-3 mb-3">
                <label class="form-label">Dosage</label>
                <input type="text" class="form-control dosage-field" name="dosage[]" readonly placeholder="Auto-filled">
            </div>

            <div class="col-md-3 mb-3">
                <label class="form-label">Stock Available</label>
                <div class="input-group">
                    <input type="text" class="form-control stock-field" readonly placeholder="0">
                    <span class="input-group-text stock-badge" style="background-color: var(--bs-secondary-bg);">OK</span>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-3 mb-3">
                <label class="form-label fw-600">Frequency <span class="text-danger">*</span></label>
                <select class="form-select frequency-field" name="frequency[]" required onchange="updateQuantity(this)">
                    <option value="">Select frequency...</option>
                    <option value="1">1 time daily</option>
                    <option value="2">2 times daily</option>
                    <option value="3">3 times daily</option>
                    <option value="4">4 times daily</option>
                    <option value="1/2">Every 12 hours (2 times daily)</option>
                    <option value="1/3">Every 8 hours (3 times daily)</option>
                    <option value="1/6">Every 6 hours (4 times daily)</option>
                    <option value="0.5">Once in 2 days</option>
                </select>
            </div>

            <div class="col-md-3 mb-3">
                <label class="form-label fw-600">Duration (Days) <span class="text-danger">*</span></label>
                <input type="number" class="form-control duration-field" name="duration_days[]" min="1" value="7" required onchange="updateQuantity(this)">
            </div>

            <div class="col-md-3 mb-3">
                <label class="form-label fw-600">Quantity <span class="text-danger">*</span></label>
                <input type="number" class="form-control quantity-field" name="quantity_prescribed[]" min="1" value="1" required readonly style="background-color: var(--bs-secondary-bg);">
                <small class="text-muted">Auto-calculated</small>
            </div>

            <div class="col-md-3 mb-3">
                <label class="form-label">Status</label>
                <input type="text" class="form-control status-field" value="PENDING" readonly style="background-color: var(--bs-warning); opacity: 0.7; color: var(--bs-emphasis-color);">
            </div>
        </div>

        <div class="stock-status-warning" style="display: none;">
            <div class="stock-warning">
                <i class="bi bi-exclamation-triangle"></i> 
                <strong>Out of Stock:</strong> This medicine will be marked for purchasing. A placeholder will be created.
            </div>
        </div>

        <div class="row">
            <div class="col-12 mb-3">
                <label class="form-label">Instructions</label>
                <textarea class="form-control" name="instructions[]" rows="2" placeholder="e.g., Take with food, avoid dairy products"></textarea>
            </div>
        </div>
        
        <!-- Hidden field to store new medicine data if medicine_id is 'NEW' -->
        <input type="hidden" name="is_new_medicine[]" class="new_medicine_data" value="">
    </div>
</template>

<!-- New Medicine Modal -->
<div class="modal fade" id="newMedicineModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Medicine</h5>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-600">Medicine Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="newMedicineName" placeholder="e.g., Azithromycin">
                </div>
                <div class="mb-3">
                    <label class="form-label">Generic Name</label>
                    <input type="text" class="form-control" id="newMedicineGeneric" placeholder="e.g., Azithromycin">
                </div>
                <div class="mb-3">
                    <label class="form-label">Dosage (e.g., 500mg)</label>
                    <input type="text" class="form-control" id="newMedicineDosage" placeholder="e.g., 500mg Tablets">
                </div>
                <div class="mb-3">
                    <label class="form-label">Unit</label>
                    <select class="form-select" id="newMedicineUnit">
                        <option>Tablets</option>
                        <option>Capsules</option>
                        <option>ml</option>
                        <option>Injections</option>
                        <option>Patches</option>
                        <option>Cream</option>
                        <option>Drops</option>
                    </select>
                </div>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> This medicine will be created as a temporary placeholder and can be replaced later with the actual medicine from stock.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelNewMedicineBtn">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmNewMedicine()">Add Medicine</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    let medicineRowCount = 0;
    let newMedicineModal = null;
    let currentMedicineSelect = null;  // Track which select opened the modal

    function addMedicineRow() {
        const template = document.getElementById('medicineRowTemplate');
        const clone = template.content.cloneNode(true);
        const medicinesList = document.getElementById('medicinesList');
        
        medicinesList.appendChild(clone);
        medicineRowCount++;
        
        initializeSelect2();
    }

    function removeMedicineRow(btn) {
        const row = btn.closest('.medicine-item');
        if (document.querySelectorAll('.medicine-item').length > 1) {
            row.style.animation = 'slideOut 0.3s ease-out';
            setTimeout(() => row.remove(), 300);
        } else {
            alert('You must have at least one medicine in the prescription.');
        }
    }

    function updateQuantity(field) {
        const row = field.closest('.medicine-item');
        const frequencyField = row.querySelector('.frequency-field');
        const durationField = row.querySelector('.duration-field');
        const quantityField = row.querySelector('.quantity-field');
        
        const frequency = frequencyField.value;
        const duration = parseInt(durationField.value) || 0;
        
        if (frequency && duration > 0) {
            let frequencyMultiplier = 1;
            
            // Parse frequency value
            if (frequency.includes('/')) {
                // For fractional frequencies like "1/2" (every 12 hours)
                const parts = frequency.split('/');
                frequencyMultiplier = parseInt(parts[0]) / parseInt(parts[1]);
            } else {
                frequencyMultiplier = parseFloat(frequency);
            }
            
            // Calculate quantity: frequency * duration
            const calculatedQuantity = Math.ceil(frequencyMultiplier * duration);
            quantityField.value = calculatedQuantity;
        }
    }

    function initializeSelect2() {
        $('.select2-med').select2({
            placeholder: 'Select a medicine...',
            allowClear: true,
            width: '100%'
        });
    }

    // Form validation
    document.getElementById('prescriptionForm').addEventListener('submit', function(e) {
        const medicines = document.querySelectorAll('.medicine-item');
        
        if (medicines.length === 0) {
            e.preventDefault();
            alert('Please add at least one medicine.');
            return false;
        }

        let validMedicines = true;
        medicines.forEach(row => {
            const medicineSelect = row.querySelector('select[name="medicine_id"]');
            const frequency = row.querySelector('select[name="frequency[]"]');
            const quantity = row.querySelector('input[name="quantity_prescribed[]"]');

            if (!medicineSelect.value) {
                validMedicines = false;
                alert('Please select a medicine for all rows.');
                return false;
            }

            if (!frequency.value) {
                validMedicines = false;
                alert('Please select frequency for all medicines.');
                return false;
            }

            if (!quantity.value || quantity.value < 1) {
                validMedicines = false;
                alert('Quantity must be at least 1.');
                return false;
            }
        });

        if (!validMedicines) {
            e.preventDefault();
        }
    });

    // Handle new medicine selection
    
    function updateMedicineDetails(select) {
        const value = select.value;
        const row = select.closest('.medicine-item');
        const hiddenField = row.querySelector('input[name="is_new_medicine[]"]');
        
        // Show modal for new medicine ONLY if it doesn't already have data
        if (value === 'NEW') {
            // Check if medicine data was already entered
            if (hiddenField && hiddenField.value && hiddenField.value !== '{}') {
                // Data already exists, just update display fields
                try {
                    const medicineData = JSON.parse(hiddenField.value);
                    row.querySelector('.dosage-field').value = medicineData.dosage || '';
                    row.querySelector('.stock-field').value = '0';
                    const stockBadge = row.querySelector('.stock-badge');
                    if (stockBadge) {
                        stockBadge.textContent = 'NEW MEDICINE';
                        stockBadge.style.backgroundColor = '#6f42c1';
                        stockBadge.style.color = 'white';
                    }
                } catch(e) {
                    console.error('Error parsing medicine data:', e);
                }
                return;
            }
            
            // No data yet, show modal
            document.getElementById('newMedicineName').value = '';
            document.getElementById('newMedicineGeneric').value = '';
            document.getElementById('newMedicineDosage').value = '';
            document.getElementById('newMedicineUnit').value = 'Tablets';
            
            // Track which select opened the modal
            currentMedicineSelect = select;
            
            // Initialize modal once if not already done
            if (!newMedicineModal) {
                newMedicineModal = new bootstrap.Modal(document.getElementById('newMedicineModal'));
            }
            newMedicineModal.show();
            return;
        }
        
        // Reset new medicine data when selecting existing medicine
        const option = select.options[select.selectedIndex];
        
        if (option.value) {
            const dosage = option.getAttribute('data-dosage') || '';
            const stock = option.getAttribute('data-stock') || '0';
            const unit = option.getAttribute('data-unit') || '';
            
            row.querySelector('.dosage-field').value = dosage;
            const stockField = row.querySelector('.stock-field');
            const stockBadge = row.querySelector('.stock-badge');
            
            stockField.value = stock;
            row.querySelector('.unit-field').textContent = unit;
            
            // Update stock badge color
            const stockNum = parseInt(stock);
            if (stockNum === 0) {
                stockBadge.textContent = 'OUT OF STOCK';
                stockBadge.style.backgroundColor = '#dc3545';
                stockBadge.style.color = 'white';
                row.querySelector('.status-field').value = 'OUT_OF_STOCK';
            } else if (stockNum < 5) {
                stockBadge.textContent = 'LOW STOCK';
                stockBadge.style.backgroundColor = '#ffc107';
                stockBadge.style.color = 'black';
                row.querySelector('.status-field').value = 'PENDING';
            } else {
                stockBadge.textContent = 'OK';
                stockBadge.style.backgroundColor = '#28a745';
                stockBadge.style.color = 'white';
                row.querySelector('.status-field').value = 'PENDING';
            }
            
            // Show warning if out of stock
            const warningDiv = row.querySelector('.stock-status-warning');
            if (stockNum === 0 && warningDiv) {
                warningDiv.style.display = 'block';
            } else if (warningDiv) {
                warningDiv.style.display = 'none';
            }
        } else {
            row.querySelector('.dosage-field').value = '';
            row.querySelector('.stock-field').value = '';
            row.querySelector('.unit-field').textContent = 'units';
            row.querySelector('.status-field').value = 'PENDING';
            const warningDiv = row.querySelector('.stock-status-warning');
            if (warningDiv) warningDiv.style.display = 'none';
            const stockBadge = row.querySelector('.stock-badge');
            if (stockBadge) {
                stockBadge.textContent = 'OK';
                stockBadge.style.backgroundColor = '#d3d3d3';
                stockBadge.style.color = 'black';
            }
        }
    }
    
    function confirmNewMedicine() {
        const name = document.getElementById('newMedicineName').value.trim();
        const generic = document.getElementById('newMedicineGeneric').value.trim();
        const dosage = document.getElementById('newMedicineDosage').value.trim();
        const unit = document.getElementById('newMedicineUnit').value;
        
        if (!name) {
            alert('Please enter medicine name');
            return;
        }
        
        const medicineData = {
            name: name,
            generic_name: generic || name,
            dosage: dosage,
            unit: unit
        };
        
        // Close modal
        if (newMedicineModal) {
            newMedicineModal.hide();
        }
        
        // Use the tracked select that opened the modal
        if (currentMedicineSelect) {
            const row = currentMedicineSelect.closest('.medicine-item');
            const hiddenField = row.querySelector('input[name="is_new_medicine[]"]');
            
            // Store the medicine data in hidden field
            if (hiddenField) {
                hiddenField.value = JSON.stringify(medicineData);
            }
            
            // Update dosage field
            const dosageField = row.querySelector('.dosage-field');
            if (dosageField) {
                dosageField.value = dosage;
            }
            
            // Update stock field and badge
            const stockField = row.querySelector('.stock-field');
            const stockBadge = row.querySelector('.stock-badge');
            if (stockField) {
                stockField.value = '0';
            }
            if (stockBadge) {
                stockBadge.textContent = 'NEW MEDICINE';
                stockBadge.style.backgroundColor = '#6f42c1';
                stockBadge.style.color = 'white';
            }
            
            // Reset tracking
            currentMedicineSelect = null;
        }
    }

    // Handle Cancel button for new medicine modal
    document.getElementById('cancelNewMedicineBtn').addEventListener('click', function() {
        // Reset the tracked select back to empty if cancelled
        if (currentMedicineSelect) {
            $(currentMedicineSelect).val('').trigger('change');
            currentMedicineSelect = null;
        }
        if (newMedicineModal) {
            newMedicineModal.hide();
        }
    });

    // Add one medicine row on page load
    document.addEventListener('DOMContentLoaded', function() {
        addMedicineRow();
        initializeSelect2();
    });
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Print Prescription - H2 System{% endblock %}

{% block content %}
<style>
    @media print {
        body {
            margin: 0;
            padding: 0;
        }

        .no-print {
            display: none !important;
        }

        .print-container {
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 0;
        }

        .page-break {
            page-break-after: always;
        }

        @page {
            size: A4;
            margin: 1cm;
        }
    }

    .print-container {
        background: white;
        max-width: 800px;
        margin: 0 auto;
        padding: 2rem;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .print-header {
        text-align: center;
        border-bottom: 3px solid var(--bs-primary);
        padding-bottom: 1.5rem;
        margin-bottom: 2rem;
    }

    .print-header h1 {
        margin: 0;
        color: var(--bs-primary);
        font-size: 2rem;
    }

    .print-header p {
        margin: 0.5rem 0 0 0;
        color: #666;
        font-size: 0.9rem;
    }

    .prescription-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 0.5rem;
    }

    .info-field {
        margin-bottom: 0.75rem;
    }

    .info-label {
        font-weight: 600;
        color: #666;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .info-value {
        color: var(--bs-body-color);
        font-size: 1.05rem;
        margin-top: 0.25rem;
    }

    .medicines-header {
        background-color: var(--bs-primary);
        color: white;
        padding: 1rem;
        margin-top: 2rem;
        margin-bottom: 1rem;
        border-radius: 0.375rem;
        font-weight: 600;
        display: flex;
        align-items-center;
        gap: 0.5rem;
    }

    .medicine-item {
        border: 1px solid #ddd;
        border-radius: 0.375rem;
        padding: 1.25rem;
        margin-bottom: 1rem;
        background-color: #fafafa;
    }

    .medicine-item:last-child {
        margin-bottom: 0;
    }

    .medicine-name {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--bs-primary);
        margin-bottom: 0.5rem;
    }

    .medicine-generic {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 1rem;
        font-style: italic;
    }

    .medicine-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #ddd;
    }

    .detail {
        font-size: 0.95rem;
    }

    .detail-label {
        color: #666;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
        display: block;
        margin-bottom: 0.25rem;
    }

    .detail-value {
        color: var(--bs-body-color);
        font-size: 1rem;
    }

    .instructions {
        color: var(--bs-body-color);
        font-style: italic;
        padding: 0.75rem;
        background-color: #fff8e1;
        border-left: 3px solid #ffc107;
        margin-top: 0.75rem;
        font-size: 0.95rem;
    }

    .dummy-details {
        background-color: #fff3cd;
        border: 2px dashed #ffc107;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-top: 1rem;
    }

    .dummy-details-header {
        font-weight: 600;
        color: #856404;
        margin-bottom: 0.5rem;
        display: flex;
        align-items-center;
        gap: 0.5rem;
    }

    .dummy-details-content {
        color: #856404;
        font-size: 0.95rem;
    }

    .dummy-details-row {
        margin-bottom: 0.5rem;
    }

    .dummy-details-row strong {
        color: #664d03;
    }

    .status-badge {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        border-radius: 50rem;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 0.5rem;
    }

    .status-pending {
        background-color: #d1ecf1;
        color: #0c5460;
    }

    .status-partial {
        background-color: #fff3cd;
        color: #856404;
    }

    .status-dispensed {
        background-color: #d4edda;
        color: #155724;
    }

    .status-out-of-stock {
        background-color: #f8d7da;
        color: #721c24;
    }

    .print-notes {
        background-color: #e7f3ff;
        border-left: 4px solid var(--bs-info);
        padding: 1rem;
        border-radius: 0.375rem;
        margin-top: 2rem;
        color: #004085;
    }

    .print-footer {
        text-align: center;
        margin-top: 3rem;
        padding-top: 1.5rem;
        border-top: 1px solid #ddd;
        color: #666;
        font-size: 0.85rem;
    }

    .no-print-section {
        background-color: #f0f0f0;
        padding: 1.5rem;
        border-radius: 0.5rem;
        margin-bottom: 2rem;
    }

    .btn-group-print {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .btn-print-action {
        flex: 1;
        padding: 0.75rem 1rem;
        font-weight: 600;
    }

    @media (max-width: 576px) {
        .print-container {
            padding: 1rem;
        }

        .prescription-info {
            grid-template-columns: 1fr;
        }

        .medicine-details {
            grid-template-columns: 1fr;
        }

        .no-print-section {
            margin-bottom: 1rem;
        }
    }
</style>

<div class="container mt-4 mb-4">
    <!-- Print Options (No Print) -->
    <div class="no-print-section no-print">
        <h3 class="mb-3"><i class="bi bi-printer"></i> Prescription Print Options</h3>
        <p class="text-muted mb-3">Choose how to print this prescription:</p>
        
        <div class="btn-group-print">
            <a href="{{ url_for('health.print_prescription', prescription_id=prescription.id, include_dummy_details='true') }}" class="btn btn-primary btn-print-action">
                <i class="bi bi-file-earmark-pdf"></i> Print Full Details (with Supplier Info)
            </a>
            <a href="{{ url_for('health.print_prescription', prescription_id=prescription.id, include_dummy_details='false') }}" class="btn btn-info btn-print-action">
                <i class="bi bi-file-earmark"></i> Print Patient Copy (without Supplier Info)
            </a>
        </div>

        <div class="mt-3">
            <button class="btn btn-secondary" onclick="window.print()">
                <i class="bi bi-printer-fill"></i> Print Page
            </button>
            <a href="{{ url_for('health.view_prescription', prescription_id=prescription.id) }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Prescription
            </a>
        </div>
    </div>

    <!-- Printable Prescription -->
    <div class="print-container">
        <!-- Header -->
        <div class="print-header">
            <h1><i class="bi bi-prescription2"></i> PRESCRIPTION</h1>
            <p>H2 Health Management System</p>
        </div>

        <!-- Prescription Info -->
        <div class="prescription-info">
            <div>
                <div class="info-field">
                    <div class="info-label">Student Name</div>
                    <div class="info-value">{{ prescription.student.user.first_name }} {{ prescription.student.user.last_name }}</div>
                </div>
            </div>
            <div>
                <div class="info-field">
                    <div class="info-label">Roll Number</div>
                    <div class="info-value">{{ prescription.student.roll_number }}</div>
                </div>
            </div>
            <div>
                <div class="info-field">
                    <div class="info-label">Prescription Date</div>
                    <div class="info-value">{{ prescription.created_at.strftime('%d %B %Y') }}</div>
                </div>
            </div>
            <div>
                <div class="info-field">
                    <div class="info-label">Prescription ID</div>
                    <div class="info-value">#{{ prescription.id }}</div>
                </div>
            </div>
            {% if prescription.visit %}
            <div>
                <div class="info-field">
                    <div class="info-label">Doctor Name</div>
                    <div class="info-value">{{ prescription.visit.doctor.first_name }} {{ prescription.visit.doctor.last_name }}</div>
                </div>
            </div>
            {% endif %}
            {% if prescription.created_by %}
            <div>
                <div class="info-field">
                    <div class="info-label">Prescribed By</div>
                    <div class="info-value">{{ prescription.created_by.first_name }} {{ prescription.created_by.last_name }}</div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Medicines Section -->
        <div class="medicines-header">
            <i class="bi bi-capsule"></i> Prescribed Medicines
        </div>

        {% if prescription.items %}
            {% for item in prescription.items %}
            <div class="medicine-item">
                <!-- Medicine Name with Status -->
                <div class="medicine-name">
                    {{ item.get_medicine().name }}
                    <span class="status-badge status-{{ item.status.lower() }}">{{ item.status }}</span>
                </div>

                <!-- Generic Name -->
                {% if item.get_medicine().generic_name %}
                <div class="medicine-generic">Generic: {{ item.get_medicine().generic_name }}</div>
                {% endif %}

                <!-- Medicine Details -->
                <div class="medicine-details">
                    <div class="detail">
                        <span class="detail-label">Dosage</span>
                        <span class="detail-value">{{ item.dosage }}</span>
                    </div>
                    <div class="detail">
                        <span class="detail-label">Frequency</span>
                        <span class="detail-value">{{ item.frequency }}</span>
                    </div>
                    <div class="detail">
                        <span class="detail-label">Duration</span>
                        <span class="detail-value">{{ item.duration_days }} days</span>
                    </div>
                    <div class="detail">
                        <span class="detail-label">Quantity Prescribed</span>
                        <span class="detail-value">{{ item.quantity_prescribed }} {{ item.get_medicine().unit }}</span>
                    </div>

                    {% if item.quantity_dispensed and item.quantity_dispensed > 0 %}
                    <div class="detail">
                        <span class="detail-label">Quantity Dispensed</span>
                        <span class="detail-value">{{ item.quantity_dispensed }} {{ item.get_medicine().unit }}</span>
                    </div>
                    {% endif %}
                </div>

                <!-- Instructions -->
                {% if item.instructions %}
                <div class="instructions">
                    <strong>Instructions:</strong> {{ item.instructions }}
                </div>
                {% endif %}

                <!-- Dummy Medicine Details (Conditional) -->
                {% if item.dummy_medicine_id and include_dummy_details %}
                <div class="dummy-details">
                    <div class="dummy-details-header">
                        <i class="bi bi-exclamation-triangle"></i> Medicine Details for Purchasing
                    </div>
                    <div class="dummy-details-content">
                        {% if item.dummy_medicine.supplier %}
                        <div class="dummy-details-row">
                            <strong>Supplier:</strong> {{ item.dummy_medicine.supplier }}
                        </div>
                        {% endif %}

                        {% if item.dummy_medicine.estimated_cost %}
                        <div class="dummy-details-row">
                            <strong>Estimated Cost:</strong> â‚¹{{ item.dummy_medicine.estimated_cost }}
                        </div>
                        {% endif %}

                        {% if item.dummy_medicine.notes %}
                        <div class="dummy-details-row">
                            <strong>Notes:</strong> {{ item.dummy_medicine.notes }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-warning" role="alert">
                No medicines in this prescription.
            </div>
        {% endif %}

        <!-- Prescription Notes -->
        {% if prescription.notes %}
        <div class="print-notes">
            <strong><i class="bi bi-chat-left-text"></i> Prescription Notes:</strong>
            <p class="mb-0 mt-2">{{ prescription.notes }}</p>
        </div>
        {% endif %}

        <!-- Footer -->
        <div class="print-footer">
            <p>Printed on: {{ now.strftime('%d %B %Y at %H:%M') }}</p>
            <p style="margin-top: 1rem; font-size: 0.8rem;">This is a computer-generated prescription. Please verify all details before dispensing or administering medicines.</p>
        </div>
    </div>

    <!-- No Print Footer Navigation -->
    <div class="no-print mt-4 text-center">
        <a href="{{ url_for('health.view_prescription', prescription_id=prescription.id) }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to Prescription
        </a>
    </div>
</div>

<script>
    // Print mode indicator
    if (new URLSearchParams(window.location.search).get('include_dummy_details') === 'true') {
        console.log('Printing FULL DETAILS with supplier information');
    } else {
        console.log('Printing PATIENT COPY without supplier information');
    }
</script>
<script>window.print()</script>
{% endblock %}

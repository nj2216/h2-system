{% extends "base.html" %}

{% block title %}Create Prescription{% endblock %}

{% block content %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<style>
    /* Select2 Dark Theme Customization */
    .select2-container--default .select2-selection--single {
        border: 1px solid var(--bs-border-color);
        border-radius: 0.375rem;
        background-color: var(--bs-body-bg);
        color: var(--bs-body-color);
        min-height: 38px;
        padding: 0.375rem 0.75rem;
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
        color: var(--bs-body-color);
        padding-left: 0;
    }

    .select2-container--default.select2-container--focus .select2-selection--single {
        border-color: var(--bs-primary);
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    .select2-dropdown {
        background-color: var(--bs-body-bg);
        border-color: var(--bs-border-color);
    }

    .select2-dropdown.select2-dropdown--below {
        border-top-color: var(--bs-border-color);
    }

    .select2-results__option {
        color: var(--bs-body-color);
        padding: 8px 10px;
    }

    .select2-results__option--highlighted,
    .select2-results__option[aria-selected=true] {
        background-color: var(--bs-primary);
        color: white;
    }

    .select2-results__group {
        color: var(--bs-body-color);
    }

    .select2-search__field {
        color: var(--bs-body-color);
        background-color: var(--bs-body-bg);
        border-color: var(--bs-border-color);
    }

    .select2-container--default .select2-search--dropdown .select2-search__field {
        border-color: var(--bs-border-color);
        background-color: var(--bs-body-bg);
        color: var(--bs-body-color);
    }

    .select2-container--default .select2-selection--single .select2-selection__arrow {
        color: var(--bs-body-color);
    }

    /* Custom styling for Select2 container */
    .select2-container--default.select2-container {
        width: 100% !important;
    }

    .select2-container--default .select2-selection--single .select2-selection__arrow b {
        border-color: var(--bs-body-color) transparent transparent transparent;
    }

    /* Improve spacing and appearance */
    .select2-container--default .select2-results > .select2-results__options {
        max-height: 400px;
    }

    /* Option text styling */
    .select2-results__option {
        font-size: 14px;
        line-height: 1.5;
    }

    /* Placeholder styling */
    .select2-container--default .select2-selection--single .select2-selection__placeholder {
        color: var(--bs-secondary-color);
    }
</style>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <h2><i class="bi bi-prescription2"></i> Create Prescription</h2>
            
            <form method="POST" class="needs-validation" novalidate>
                <div class="mb-3">
                    <label for="student_id" class="form-label fw-600">
                        <i class="bi bi-person-circle"></i> Student
                        <span class="text-danger">*</span>
                    </label>
                    <select class="form-select select2" id="student_id" name="student_id" required>
                        <option value="">Search by Roll Number or Name...</option>
                        {% for student in students %}
                        <option value="{{ student.id }}" data-roll="{{ student.roll_number }}" data-name="{{ student.user.first_name }} {{ student.user.last_name }}">
                            {{ student.roll_number }} – {{ student.user.first_name }} {{ student.user.last_name }}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="invalid-feedback">Please select a student.</div>
                </div>
                
                <div class="mb-3">
                    <label for="medicine_id" class="form-label fw-600">
                        <i class="bi bi-capsule"></i> Medicine
                        <span class="text-danger">*</span>
                    </label>
                    <select class="form-select select2" id="medicine_id" name="medicine_id" required onchange="updateMedicineInfo()">
                        <option value="">Search medicine by name...</option>
                        {% for medicine in medicines %}
                        {% if medicine.quantity > 0 %}
                        <option value="{{ medicine.id }}" data-stock="{{ medicine.quantity }}" data-dosage="{{ medicine.dosage }}" data-unit="{{ medicine.unit }}">
                            {{ medicine.name }} ({{ medicine.dosage }}) – Stock: {{ medicine.quantity }} {{ medicine.unit }}
                        </option>
                        {% endif %}
                        {% endfor %}
                    </select>
                    <div class="invalid-feedback">Please select a medicine with available stock.</div>
                    <small class="d-block mt-2" id="medicineInfo" style="color: var(--bs-info);"></small>
                </div>

                <hr class="my-4">
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="dosage" class="form-label fw-600">
                            <i class="bi bi-capsule"></i> Dosage
                        </label>
                        <input type="text" class="form-control" id="dosage" name="dosage" readonly placeholder="Auto-filled from medicine">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="frequency" class="form-label fw-600">
                            <i class="bi bi-clock-history"></i> Frequency
                            <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="frequency" name="frequency" required onchange="calculateQuantity()">
                            <option value="">Select frequency...</option>
                            <option value="1">1 time daily</option>
                            <option value="2">2 times daily</option>
                            <option value="3">3 times daily</option>
                            <option value="4">4 times daily</option>
                            <option value="1/2">Every 12 hours</option>
                            <option value="1/3">Every 8 hours</option>
                            <option value="1/6">Every 6 hours</option>
                            <option value="0.5">Once in 2 days</option>
                        </select>
                        <div class="invalid-feedback">Please provide frequency.</div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="duration_days" class="form-label fw-600">
                            <i class="bi bi-calendar-event"></i> Duration (Days)
                            <span class="text-danger">*</span>
                        </label>
                        <input type="number" class="form-control" id="duration_days" name="duration_days" min="1" placeholder="e.g., 7" required onchange="calculateQuantity()">
                        <div class="invalid-feedback">Please provide duration in days.</div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="quantity_prescribed" class="form-label fw-600">
                            <i class="bi bi-boxes"></i> Quantity
                        </label>
                        <input type="number" class="form-control" id="quantity_prescribed" name="quantity_prescribed" min="1" required readonly 
                               style="background-color: var(--bs-secondary-bg); color: var(--bs-body-color);"
                               placeholder="Auto-calculated">
                        <div class="invalid-feedback">Quantity will be calculated from frequency and duration.</div>
                    </div>
                </div>

                <div class="alert alert-info mt-2" id="quantityAlert" style="display:none;">
                    <small id="quantityInfo"></small>
                </div>
                
                <div class="mb-3">
                    <label for="instructions" class="form-label fw-600">
                        <i class="bi bi-chat-left-text"></i> Special Instructions
                    </label>
                    <textarea class="form-control" id="instructions" name="instructions" rows="3" placeholder="E.g., Take with food, before meals, etc."></textarea>
                    <small class="text-muted">Optional: Add any special instructions for the patient</small>
                </div>

                <hr class="my-4">
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <a href="{{ url_for('health.prescriptions_list') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-x-circle"></i> Cancel
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> Create Prescription
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    function updateMedicineInfo() {
        const medicineSelect = document.getElementById('medicine_id');
        const selectedOption = medicineSelect.options[medicineSelect.selectedIndex];
        const medicineInfo = document.getElementById('medicineInfo');
        const dosageField = document.getElementById('dosage');
        const quantityField = document.getElementById('quantity_prescribed');
        const quantityAlert = document.getElementById('quantityAlert');
        const quantityInfo = document.getElementById('quantityInfo');
        
        if (selectedOption.value) {
            const stock = selectedOption.getAttribute('data-stock');
            const dosage = selectedOption.getAttribute('data-dosage');
            const unit = selectedOption.getAttribute('data-unit');
            
            // Auto-fill dosage
            dosageField.value = dosage || '';
            medicineInfo.innerHTML = `<i class="bi bi-check-circle"></i> Available Stock: <strong>${stock} ${unit}</strong>`;
            
            // Update quantity field validation
            quantityField.max = stock;
            
            // Recalculate quantity
            calculateQuantity();
        } else {
            dosageField.value = '';
            quantityField.value = '';
            medicineInfo.innerHTML = '';
            quantityAlert.style.display = 'none';
        }
    }
    
    function calculateQuantity() {
        const frequencyField = document.getElementById('frequency');
        const durationField = document.getElementById('duration_days');
        const quantityField = document.getElementById('quantity_prescribed');
        const quantityAlert = document.getElementById('quantityAlert');
        const quantityInfo = document.getElementById('quantityInfo');
        
        const frequencyStr = frequencyField.value;
        const duration = parseInt(durationField.value) || 0;
        
        if (!frequencyStr || duration < 1) {
            quantityField.value = '';
            quantityAlert.style.display = 'none';
            return;
        }
        
        // Parse frequency value
        let frequency = parseFloat(frequencyStr);
        
        // Calculate quantity
        let quantity = Math.ceil(frequency * duration);
        
        quantityField.value = quantity;
        
        // Check stock
        const medicineSelect = document.getElementById('medicine_id');
        const selectedOption = medicineSelect.options[medicineSelect.selectedIndex];
        if (selectedOption.value) {
            const stock = parseInt(selectedOption.getAttribute('data-stock'));
            const unit = selectedOption.getAttribute('data-unit');
            
            quantityAlert.style.display = 'block';
            
            if (quantity > stock) {
                quantityAlert.className = 'alert alert-danger mt-2';
                quantityInfo.innerHTML = `<i class="bi bi-exclamation-triangle"></i> <strong>Insufficient Stock!</strong><br>Required: ${quantity} ${unit} | Available: ${stock} ${unit}`;
            } else if (quantity > stock * 0.7) {
                quantityAlert.className = 'alert alert-warning mt-2';
                quantityInfo.innerHTML = `<i class="bi bi-exclamation-circle"></i> Required: ${quantity} ${unit} | Available: ${stock} ${unit}`;
            } else {
                quantityAlert.className = 'alert alert-success mt-2';
                quantityInfo.innerHTML = `<i class="bi bi-check-circle"></i> Required: ${quantity} ${unit} | Available: ${stock} ${unit}`;
            }
        }
    }
    
    // Form validation
    (function () {
        'use strict';
        window.addEventListener('load', function () {
            var forms = document.querySelectorAll('.needs-validation');
            Array.prototype.slice.call(forms).forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        }, false);
    }());

    // Initialize Select2 on document ready
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Select2 for searchable dropdowns
        $('#student_id').select2({
            placeholder: 'Search by Roll Number or Name...',
            allowClear: false,
            width: '100%',
            minimumInputLength: 0,
            matcher: function (params, data) {
                // If no search term, return all data
                if ($.trim(params.term) === '') {
                    return data;
                }
                
                // Skip if there's no element
                if (!data.element) {
                    return null;
                }
                
                var term = params.term.toLowerCase();
                var roll = $(data.element).attr('data-roll') || '';
                var name = $(data.element).attr('data-name') || '';
                var text = data.text.toLowerCase();
                
                if (roll.toLowerCase().indexOf(term) > -1 || 
                    name.toLowerCase().indexOf(term) > -1 || 
                    text.indexOf(term) > -1) {
                    return data;
                }
                return null;
            }
        });
        
        $('#medicine_id').select2({
            placeholder: 'Search medicine by name...',
            allowClear: false,
            width: '100%',
            minimumInputLength: 0,
            matcher: function (params, data) {
                // If no search term, return all data
                if ($.trim(params.term) === '') {
                    return data;
                }
                
                // Skip if there's no element
                if (!data.element) {
                    return null;
                }
                
                var term = params.term.toLowerCase();
                var text = data.text.toLowerCase();
                
                if (text.indexOf(term) > -1) {
                    return data;
                }
                return null;
            }
        });
    });
</script>
{% endblock %}
